<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/style.css" />
        <script type="importmap">
            {
                "imports": {
                    "api": "./modules/api.js",
                    "wrappers": "./modules/wrappers.js",
                    "dom": "./modules/dom.js"
                }
            }
        </script>
        <script type="module">
            import { getRecordSets, getRecord, deleteRecordSets } from "api";
            import { createRecord, createRecordSet, createRecordSetSummary } from "dom";
            import { RecordListResponse, RecordSet } from "wrappers";

            const params = new URLSearchParams(document.location.search);
            const rcid = params.get("record_id");

            function renderRecordSets(data) {
                const fragment = document.createDocumentFragment();
                const records = document.querySelector(".records");
                for (const rs of data.recordSets) {
                    fragment.appendChild(createRecordSet(rs, data.sourceMetadata));
                }
                records.append(fragment);
            }

            function renderRecord(cdata) {
                const fragment = document.createDocumentFragment();
                const records = document.querySelector(".records");
                fragment.appendChild(createRecordSetSummary(cdata));
                for (const record of cdata.records) {
                    fragment.appendChild(createRecord(rcid, record, cdata.sourceMetadata));
                }
                records.append(fragment);
            }

            function showLoading() {
                document.querySelector(".status .loader").style.display = "inline-block";
            }

            function hideLoading() {
                document.querySelector(".status .loader").style.display = "none";
            }

            function showError() {
                document.querySelector(".status .error").style.display = "inline-block";
            }

            function hideEror() {
                document.querySelector(".status .error").style.display = "none";
            }

            function handleError(err) {
                hideLoading();
                showError();
                
                const root = document.querySelector(".notifications");
                root.innerHTML += `<div class="error">${err}</div>`;
            }

            window.onload = () => {
                document.querySelector("#recordId .search-input").value = rcid;
                document.querySelector("#recordId button").addEventListener("click", () => {
                    const rid = document.querySelector("#recordId .search-input").value;
                    window.location.href = "?record_id=" + rid;
                });

                if (params.get("record_id")) {
                    showLoading();
                    getRecord(params.get("record_id"))
                        .then((data) => new RecordSet(data))
                        .then((data) => {
                            renderRecord(data);
                        })
                        .then(() => {
                            hideLoading();
                        });
                } else {
                    showLoading();
                    getRecordSets()
                        .then((rsObj) => new RecordListResponse(rsObj))
                        .then((data) => {
                            renderRecordSets(data);
                        })
                        .then(() => {
                            hideLoading();
                        })
                        .catch(handleError);
                }
                document.querySelector(".do_delete").addEventListener("click", () => {
                    showLoading();
                    const toDelete = [
                        ...document.querySelectorAll(".selection_marker:checked"),
                    ].map((c) => c.dataset["record"]);
                    deleteRecordSets(toDelete)
                        .then((records) => {
                            for (const r of records) {
                                if (r.Deleted == true) {
                                    document.getElementById(r.Id).parentElement.remove();
                                }
                            }
                            hideLoading();
                        })
                        .catch(handleError);
                });
            };
        </script>
    </head>

    <body>
        <nav class="topheader">
            <div class="menubar">
                <div class="title">
                    <a href="/">Chronicler</a>
                </div>
                <label for="statusbar_check">
                    <div class="status">
                        <div class="info"></div>
                        <div class="loader"></div>
                        <div class="error"></div>
                    </div>
                </label>
                <div class="menu">
                    <label for="menuitems_check">
                        <div class="hamburger-lines bar_button">
                            <span class="line"></span>
                            <span class="line"></span>
                            <span class="line"></span>
                        </div>
                    </label>
                </div>
            </div>

            <input type="checkbox" id="menuitems_check" class="toggler_check" />
            <div class="menuitems">
                <div class="menuitem">
                    <div id="recordId" class="controls">
                        <input type="text" placeholder="Post id" class="search-input" />
                        <button>Open</button>
                    </div>
                </div>
            </div>

            <input type="checkbox" id="statusbar_check" class="toggler_check" />
            <div class="menuitems">
                <div class="menuitem notifications">
                
                </div>
            </div>
        </nav>
        <div class="records"></div>
        <div class="footer">
            <div class="bar_button do_delete">Delete</div>
        </div>
    </body>
</html>
