<html>
    <head>
        <link rel='stylesheet' href='style.css' />
        <script>
            const type = 'twitter';
            const rcid = '1636761535371706374';
            const imgExtensions = ['png', 'jpg', 'svg', 'gif', 'webp'];

            window.onload = () => {
                Map.prototype.getOrElse = function(key, value) {
                    return this.has(key) ? this.get(key) : value;
                }

                function pad(number, len = 2) {
                    return String(number).padStart(2, '0');
                }

                function formatDateTime(date) {
                    return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ` +
                           `${pad(date.getHours())}:${pad(date.getMinutes())}`;
                }

                function isImage(path) {
                    return imgExtensions.includes(getExtension(path.toLowerCase()));
                }

                function getExtension(path) {
                    const lastIndex = path.lastIndexOf('.');
                    return (lastIndex > -1 && lastIndex < path.length) ? 
                        path.substring(lastIndex + 1) : "";
                }

                function getFileName(path) {
                    const lastIndex = path.lastIndexOf('/');
                    return (lastIndex > -1 && lastIndex < path.length) ? 
                        path.substring(lastIndex + 1) : "";
                }

                fetch(`/chronicler?type=${type}&id=${rcid}`)
                .then(response => response.text())
                .then(text => {
                    const data = JSON.parse(text);
                    const fragment = document.createDocumentFragment();
                    const records = document.querySelector('.records');

                    const userById = new Map();
                    for (const user of data.userMetadata) {
                        userById.set(user.id, user);
                    }

                    const recordById = new Map();
                    for (const record of data.records) {
                        if (!record.source) {
                            continue;
                        }
                        recordById.set(record.source.message_id, record);
                    }

                    function getUserName(id) {
                        return userById.has(id) ? userById.get(id).username : id;
                    }

                    function getParent(record) {
                        if (record.parent) {
                            return recordById.get(record.parent.message_id);
                        }
                        if (record.source.channel_id) {
                            return recordById.get(record.source.channel_id);
                        }
                        return undefined;
                    }

                    for (const record of data.records) {
                        const date = new Date(record.time * 1000);
                        const userName = getUserName(record.source.sender_id);
                        const parent = getParent(record);
                        const parentName = parent ? getUserName(parent.source.sender_id) : 'NONE';

                        const recordEl = document.createElement('div');
                        recordEl.setAttribute('id', record.source.message_id)
                        recordEl.setAttribute('class', 'record');
                        recordEl.innerHTML = `<div class='header'>
                          <span class="datetime">${formatDateTime(date)}</span>
                          <a href="#${record.source.message_id}">#</a>
                          <span class="username">${userName}</span>
                          <span class="username">â†’ <a href="#${parent.source.message_id}">${parentName}</a></span>
                        </div>
                        <div class='content'>${record.text_content}</div>`;

                        const images = [];
                        const others = [];
                        for (const file of record.files ?? []) {
                            const fname = getFileName(file.file_url);
                            if (isImage(fname)) {
                                images.push(fname);
                            } else {
                                others.push(fname);
                            }
                        }

                        const imagesEl = document.createElement('div')
                        imagesEl.setAttribute('class', 'images');                        
                        for (const file of images) {
                            imagesEl.innerHTML += `<div class="image">
                                    <a href="chronicler?type=${type}&id=${rcid}&file=${file}">
                                    <img src="chronicler?type=${type}&id=${rcid}&file=${file}" />
                                    </a>
                                </div>`;
                        }

                        const filesEl = document.createElement('div')
                        filesEl.setAttribute('class', 'files');
                        for (const file of others) {
                            filesEl.innerHTML += `<div class="file">
                                <a href="chronicler?type=${type}&id=${rcid}&file=${file}">
                            </div>`;
                        }
                        recordEl.appendChild(imagesEl);
                        recordEl.appendChild(filesEl);
                        fragment.appendChild(recordEl);
                    }
                    records.append(fragment);
                });
            };
        </script>
    </head>
    <body>
        <div class="records"> 
        </div>
    </body>
</html>
